<!DOCTYPE html>
<html lang="pt-br">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE-edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Arduino Node.js</title>
 
	<!-- Socket.io - aqui chamamos nosso socket. -->
	<script src="/socket.io/socket.io.js"></script>
 
	<!-- Chart - aqui chamamos nossa lib que gera o gráfico. -->
	<script src="js/Chart.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
</head>
 
<body>
    <!-- criamos um canvas e atribuímos um tamanho que será o gráfico. -->
	<canvas id="myChart" width="600" height="200"></canvas>
	<script type="text/javascript">
		var contador = 0; // contador para gerar o eixo x do gráfico 
		var ctx = document.getElementById("myChart").getContext("2d");
		var myChart = new Chart(ctx, {
			type: 'line',
			data: {
				labels: [],
				datasets: [
					{
						label: ["Eixo X"],
						backgroundColor: "rgba(255, 99, 132)",
						borderColor: "rgba(255, 99, 132)",
						data: [],
						fill: false,
					},
					{
						label: ["Eixo Y"],
						backgroundColor: "rgba(51, 204, 255)",
						borderColor: "rgb(51, 204, 255)",
						data: [],
						fill: false,
					},
					{
						label: ["Eixo Z"],
						backgroundColor: "rgba(255, 204, 0)",
						borderColor: "rgba(255, 204, 0)",
						data: [],
						fill: false,
					}
				]
			},
			options: {
				scales: {
					yAxes: [{
						scaleLabel: {
							display: true,
							labelString: 'Aceleração (m/s²)'
						}
					}],
					xAxes: [{
						scaleLabel: {
							display: true,
							labelString: 'Tempo (s)',
							type: 'time',
						},
					}]
				}     
}
		});

		let k = 0;

		function addData(chart, label, data, eixo) {
			k++;
			if(k == 3){
				myChart.data.labels.push(label);
				k = 0;
			}

			if (eixo == 'x')
				myChart.data.datasets[0].data.push(data);
			if (eixo == 'y')
				myChart.data.datasets[1].data.push(data);
			if (eixo == 'z')
				myChart.data.datasets[2].data.push(data);	

			myChart.update();
		}

		var inicio = Date.now();

		var socket = io();
		socket.on("dadosArduino", function(dado) {	
			//
			console.log('Dados: ' + myChart.data.datasets[0].data);
			console.log('labels: ' + myChart.data.labels);
			const eixo = dado.substring(0,1);
			console.log('eixo: ' + eixo);
			const newDado = dado.substring(1);
			console.log('dado: ' + newDado);
			let dadoTratado = (parseInt(newDado) / 16384) * 9.81;
			console.log('dadoTratado: ' + dadoTratado);
			if(dado != null){	
				addData(myChart, (Date.now() - inicio)/1000, dadoTratado, eixo);
			}		
		});
	</script>
 
</body>
</html>